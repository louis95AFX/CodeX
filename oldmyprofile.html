<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - CodeX</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
</head>
<!-- Spinner styles (you can put this in your CSS file or inside <style>) -->
  <style>
    .loader {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  </style>
<body class="bg-gray-100 text-gray-800">

  <!-- Header -->
  <header class="bg-white p-4 shadow fixed top-0 w-full z-10">
    <div class="container mx-auto flex justify-between items-center">
      <img src="codexbg.png" alt="Logo" class="h-12">
      <h2 class="text-xl font-semibold" id="welcomeMessage"></h2>
      <!-- Logout Icon -->
      <a href="codex.html" class="text-gray-600 hover:text-red-600 text-xl flex items-center gap-2">
        <i class="fas fa-sign-out-alt"></i>
        <span class="text-sm">Log out</span>
      </a>
    </div>
  </header>

  <main class="pt-24 container mx-auto px-4">
    <div class="bg-white p-6 rounded shadow mb-6">
      <div class="flex items-center justify-between w-full">
        <!-- Profile Section -->
        <div class="flex items-center space-x-4 pr-10"> <!-- Add padding-right here -->
          <div class="relative group">
            <img
              id="profilePic"
              src="http://localhost:5000/uploads/default-profile.png"
              alt="Profile Picture"
              class="w-16 h-16 rounded-full border border-gray-300 object-cover"
            />
            <label
              for="profileImage"
              class="absolute bottom-0 right-0 bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center cursor-pointer"
              title="Upload Profile Picture"
            >
              <span class="text-sm">+</span>
              <input
                type="file"
                id="profileImage"
                name="profileImage"
                accept="image/*"
                class="hidden"
                onchange="previewImage(event)"
              />
            </label>
            <div
              class="absolute bottom-10 right-0 bg-gray-800 text-white text-xs py-1 px-2 rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-300"
            >
              Upload Profile Picture
            </div>
          </div>
    
          <div>
            <h3 class="text-xl font-semibold" id="userName">User Name</h3>
            <p class="text-sm text-gray-600" id="studentNumber">Student Number</p>
          </div>
        </div>
    
        <!-- ðŸŽ¯ Centered Purchase Button (Blue) -->
        <button
          onclick="handlePurchase()"
          class="px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded shadow">
          View all available courses
        </button>
      </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- My Courses -->
      <div class="bg-white p-6 rounded shadow hover:shadow-md transition">
        <div class="flex items-center gap-2 mb-2">
          <i class="fas fa-book-reader text-blue-600 text-lg"></i>
          <h3 class="text-lg font-semibold">My Courses</h3>
        </div>
        <ul id="coursesList" class="space-y-2 mb-4"></ul>
        <div class="text-right">
          <a href="#courses" class="text-sm text-white bg-blue-600 px-4 py-1 rounded hover:bg-blue-700 transition inline-block">
            My Courses
          </a>
        </div>
      </div>
      
      <!-- Progress -->
      <div class="bg-white p-6 rounded shadow hover:shadow-md transition">
        <div class="flex items-center gap-2 mb-2">
          <i class="fas fa-chart-line text-green-600 text-lg"></i>
          <h3 class="text-lg font-semibold">Course Progress</h3>
        </div>
        <div id="progressList"></div>
      </div>

      <!-- Certificates -->
      <div class="bg-white p-6 rounded shadow hover:shadow-md transition">
        <div class="flex items-center gap-2 mb-2">
          <i class="fas fa-award text-yellow-500 text-lg"></i>
          <h3 class="text-lg font-semibold">Certificates</h3>
        </div>
        <p id="certificateCountText">You have earned <strong id="certificateCount">0 certificates</strong>.</p>
        <a href="#" class="text-blue-600 font-semibold hover:text-blue-800 mt-2 inline-block transition">View Certificate</a>
      </div>

      <!-- Payment History -->
      <div class="bg-white p-6 rounded shadow hover:shadow-md transition">
        <div class="flex items-center gap-2 mb-2">
          <i class="fas fa-receipt text-purple-500 text-lg"></i>
          <h3 class="text-lg font-semibold">Payment History</h3>
        </div>
        <ul id="paymentHistory" class="text-sm space-y-2"></ul>
      </div>

      <!-- Account Settings -->
      <div class="bg-white p-6 rounded shadow hover:shadow-md transition">
        <div class="flex items-center gap-2 mb-2">
          <i class="fas fa-user-cog text-orange-500 text-lg"></i>
          <h3 class="text-lg font-semibold">Account Settings</h3>
        </div>
        <ul class="text-sm space-y-2">
          <li><a href="forgotpass.html" class="text-blue-600 font-semibold hover:text-blue-800 transition">Change Password</a></li>
          <li><a href="#" class="text-blue-600 font-semibold hover:text-blue-800 transition">Update Email</a></li>
          <li><a href="#" class="text-blue-600 font-semibold hover:text-blue-800 transition">Notification Preferences</a></li>
        </ul>
      </div>

      <!-- Support -->
      <div class="bg-white p-6 rounded shadow hover:shadow-md transition">
        <div class="flex items-center gap-2 mb-2">
          <i class="fas fa-headset text-red-500 text-lg"></i>
          <h3 class="text-lg font-semibold">Support</h3>
        </div>
        <p>Need help or have questions?</p>
        <a href="#" class="text-blue-600 font-semibold hover:text-blue-800 transition">Contact Support</a>
      </div>

    </div>
  </main>
  <div id="loadingSpinner" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.8); display: flex; justify-content: center;
  align-items: center; z-index: 9999;">
  <div class="loader"></div>
</div>

  <!-- Footer -->
  <footer class="bg-gray-800 shadow mt-12">
    <div class="container mx-auto px-4 py-6 flex flex-col md:flex-row justify-between items-center text-sm text-gray-300">
      <p>&copy; 2025 CodeX Academy. All rights reserved.</p>
      <div class="flex space-x-6">
        <a href="#privacy" class="hover:text-blue-400 transition">Privacy Policy</a>
        <a href="#terms" class="hover:text-blue-400 transition">Terms of Service</a>
        <a href="#faq" class="hover:text-blue-400 transition">FAQ</a>
      </div>
      <div class="flex space-x-4">
        <a href="https://facebook.com" target="_blank" class="hover:text-blue-500 transition"><i class="fab fa-facebook-f"></i></a>
        <a href="https://instagram.com" target="_blank" class="hover:text-pink-500 transition"><i class="fab fa-instagram"></i></a>
        <a href="https://twitter.com" target="_blank" class="hover:text-blue-400 transition"><i class="fab fa-x-twitter"></i></a>
      </div>
    </div>
  </footer>

  <script>
    // Preview image and upload to server
    function previewImage(event) {
      const selectedFile = event.target.files[0];
      const output = document.getElementById("profilePic");
  
      if (selectedFile) {
        const reader = new FileReader();
        reader.onload = () => {
          output.src = reader.result; // Temporary preview
        };
        reader.readAsDataURL(selectedFile);
      } else {
        return;
      }
  
      const userId = localStorage.getItem("userID");
      if (!userId) {
        alert("You are not logged in.");
        window.location.href = "codex.html";
        return;
      }
  
      const formData = new FormData();
      formData.append("profilePic", selectedFile);
  
      fetch(`http://localhost:5000/upload-profile-pic/${userId}`, {
        method: "POST",
        body: formData,
      })
        .then(res => res.json())
        .then(data => {
          if (data.imageUrl) {
            output.src = `http://localhost:5000${data.imageUrl}`;
          } else {
            console.warn("Server did not return an imageUrl");
          }
        })
        .catch(err => {
          console.error("Upload error:", err);
        });
    }
  
    // Redirect to course purchase
    function handlePurchase() {
      window.location.href = 'purchase.html';
    }
  
    // Main logic runs after DOM is loaded
    document.addEventListener("DOMContentLoaded", async () => {
      const spinner = document.getElementById("loadingSpinner");
      if (spinner) spinner.style.display = "flex";
  
      const userId = localStorage.getItem("userID");
      const userEmail = localStorage.getItem("userEmail");
  
      if (!userId) {
        alert("You are not logged in.");
        window.location.href = "codex.html";
        return;
      }
  
      try {
        // Fetch and populate user data
        const res = await fetch(`http://localhost:5000/user/${userId}`);
        if (!res.ok) throw new Error("Failed to fetch user data");
        const userData = await res.json();
  
        document.getElementById("welcomeMessage").textContent = `Welcome, ${userData.name}`;
        document.getElementById("userName").textContent = userData.name;
        document.getElementById("studentNumber").textContent = `Student Number: ${userData.student_id}`;
  
        const certCount = userData.certificateCount || 0;
        document.getElementById("certificateCount").textContent = `${certCount} certificate${certCount !== 1 ? 's' : ''}`;
  
        const coursesList = document.getElementById("coursesList");
        const progressList = document.getElementById("progressList");
        const paymentHistory = document.getElementById("paymentHistory");
  
        if (userData.courses && Array.isArray(userData.courses)) {
          userData.courses.forEach(course => {
            const listItem = document.createElement("li");
            listItem.className = "flex justify-between items-center";
            listItem.innerHTML = `<span>${course.name}</span><button class='text-blue-600 font-semibold hover:text-blue-800 transition'>Continue</button>`;
            coursesList.appendChild(listItem);
  
            const progressItem = document.createElement("div");
            progressItem.className = "mb-4";
            progressItem.innerHTML = `
              <div class='flex justify-between items-center mb-1'>
                <p>${course.name}</p>
                <span class='text-sm font-medium text-gray-600'>${course.progress}%</span>
              </div>
              <div class='w-full bg-gray-200 rounded-full h-2'>
                <div class='bg-blue-600 h-2 rounded-full' style='width: ${course.progress}%'></div>
              </div>`;
            progressList.appendChild(progressItem);
          });
        }
  
        if (userData.paymentHistory && Array.isArray(userData.paymentHistory)) {
          userData.paymentHistory.forEach(payment => {
            const paymentItem = document.createElement("li");
            paymentItem.innerHTML = `${payment.course} â€“ ${payment.amount} â€“ <span class='text-green-600 font-semibold'>${payment.status}</span>`;
            paymentHistory.appendChild(paymentItem);
          });
        }
  
        if (userData.profilePic) {
          const profilePic = document.getElementById("profilePic");
          profilePic.src = `http://localhost:5000${userData.profilePic}`;
        }
      } catch (err) {
        console.error("Error loading user data:", err);
      }
  
      // Load course links
      if (userEmail) {
        try {
          const response = await fetch(`http://localhost:5000/getUserCourses?email=${encodeURIComponent(userEmail)}`);
          const courses = await response.json();
  
          const coursesList = document.getElementById("coursesList");
          coursesList.innerHTML = "";
  
          if (courses.length === 0) {
            coursesList.innerHTML = `<li class="text-gray-600">You haven't enrolled in any courses yet.</li>`;
          } else {
            const coursePageMap = {
              "Web Development": "webdev.html",
              "Graphic Design": "graphicdesign.html",
              "Digital Marketing": "digitalmarketing.html",
              "Cybersecurity" : "cybercourse.html",
              "Mobile App Development" : "mobileapp.html",
              "UI/UX Design" : "uiux.html"
            };
  
            courses.forEach(course => {
              const listItem = document.createElement("li");
              listItem.className = "p-2 bg-gray-100 rounded hover:bg-blue-100 transition";
  
              const courseName = course.course;
              const courseLink = coursePageMap[courseName] || `course.html?courseName=${encodeURIComponent(courseName)}`;
  
              listItem.innerHTML = `
                <a href="${courseLink}" class="block text-blue-700">
                  <strong>${courseName}</strong>
                </a>
              `;
  
              coursesList.appendChild(listItem);
            });
          }
        } catch (error) {
          console.error("Error loading user courses:", error);
          document.getElementById("coursesList").innerHTML = `<li class="text-red-600">Failed to load courses.</li>`;
        }
      }
  
      if (spinner) spinner.style.display = "none";
    });

    document.addEventListener('DOMContentLoaded', () => {
    const email = localStorage.getItem('userEmail'); // assuming you store email locally
    const historyList = document.getElementById('paymentHistory');

    if (!email) {
      historyList.innerHTML = '<li>No user logged in.</li>';
      return;
    }

    fetch(`http://localhost:5000/getPurchases?email=${encodeURIComponent(email)}`)
      .then(res => res.json())
      .then(data => {
        if (data.length === 0) {
          historyList.innerHTML = '<li>No purchases found.</li>';
          return;
        }

        historyList.innerHTML = ''; // clear placeholder

        data.forEach(entry => {
          const li = document.createElement('li');
          li.className = 'flex justify-between items-center border-b pb-1';
          li.innerHTML = `
            <span class="font-medium">${entry.course}</span>
            <span class="text-gray-600">
  R${entry.amount ? parseFloat(entry.amount).toFixed(2) : '0.00'}
</span>

            <span class="text-xs text-gray-400">${new Date(entry.created_at).toLocaleDateString()}</span>
          `;
          historyList.appendChild(li);
        });
      })
      .catch(err => {
        console.error('Failed to load payment history:', err);
        historyList.innerHTML = '<li>Error loading history.</li>';
      });
  });
  </script>
  
</body>
</html>
